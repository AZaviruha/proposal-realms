{"version":3,"file":null,"sources":["../src/sandbox.js","../src/sanitize.js","../src/proxy.js","../src/evaluate.js","../src/evaluators.js","../src/intrinsics.js","../src/stdlib.js","../src/realm.js"],"sourcesContent":["function createIframe() {\n    const el = document.createElement(\"iframe\");\n    el.style.display = \"none\";\n    // accessibility\n    el.title = \"script\";\n    el.setAttribute('aria-hidden', true);\n    document.body.appendChild(el);\n    return el;\n}\n\nexport function createSandbox() {\n    const iframe = createIframe();\n    const { contentDocument: iframeDocument, contentWindow: confinedWindow } = iframe;\n    const globalObject = confinedWindow.Object.create(null);\n    return {\n        iframe,\n        iframeDocument,\n        confinedWindow,\n        globalObject,\n        globalProxy: undefined,\n    };\n}","// locking down the environment\nexport function sanitize(sandbox) {\n    const { confinedWindow: { Object: o } } = sandbox;\n    try {\n        // Fixing properties of Object to comply with strict mode\n        // and ES2016 semantics, we do this by redefining them while in 'use strict'\n        // https://tc39.github.io/ecma262/#sec-object.prototype.__defineGetter__\n        if (o === undefined) {\n            return;\n        }\n        o.defineProperty(o.prototype, '__defineGetter__', {\n            value: function (key, fn) {\n                return o.defineProperty(this, key, {\n                    get: fn\n                });\n            }\n        });\n        o.defineProperty(o.prototype, '__defineSetter__', {\n            value: function (key, fn) {\n                return o.defineProperty(this, key, {\n                    set: fn\n                });\n            }\n        });\n        o.defineProperty(o.prototype, '__lookupGetter__', {\n            value: function (key) {\n                var d, p = this;\n                while (p && (d = o.getOwnPropertyDescriptor(p, key)) === undefined) {\n                    p = o.getPrototypeOf(this);\n                }\n                return d ? d.get : undefined;\n            }\n        });\n        o.defineProperty(o.prototype, '__lookupSetter__', {\n            value: function (key) {\n                var d, p = this;\n                while (p && (d = o.getOwnPropertyDescriptor(p, key)) === undefined) {\n                    p = o.getPrototypeOf(this);\n                }\n                return d ? d.set : undefined;\n            }\n        });\n        // Immutable Prototype Exotic Objects\n        // https://github.com/tc39/ecma262/issues/272\n        o.seal(o.prototype);\n    } catch (ignore) {\n        // Ignored\n    }\n}","let isInternalEvaluation = false;\n\nexport function setInternalEvaluation() {\n    isInternalEvaluation = true;\n}\n\nexport function resetInternalEvaluation() {\n    isInternalEvaluation = false;\n}\n\nexport const proxyHandler = {\n    get(sandbox, propName) {\n        if (propName === 'eval' && isInternalEvaluation) {\n            resetInternalEvaluation();\n            return sandbox.confinedWindow.eval;\n        }\n        return sandbox.globalObject[propName];\n    },\n    set(sandbox, propName, newValue) {\n        sandbox.globalObject[propName] = newValue;\n        return true;\n    },\n    defineProperty(sandbox, propName, descriptor) {\n        Object.defineProperty(sandbox.globalObject, propName, descriptor);\n        return true;\n    },\n    deleteProperty(sandbox, propName) {\n        return Reflect.deleteProperty(sandbox.globalObject, propName);\n    },\n    has(sandbox, propName) {\n        if (propName === 'eval' && isInternalEvaluation) {\n            return true;\n        }\n        if (propName in sandbox.globalObject) {\n            return true;\n        } else if (propName in sandbox.confinedWindow) {\n            throw new ReferenceError(`${propName} is not defined. If you are using typeof ${propName}, you can change your program to use typeof global.${propName} instead`);\n        }\n        return false;\n    },\n    ownKeys(sandbox) {\n        return Object.getOwnPropertyNames(sandbox.globalObject);\n    },\n    getOwnPropertyDescriptor(sandbox, propName) {\n        return Object.getOwnPropertyDescriptor(sandbox.globalObject, propName);\n    },\n    isExtensible(sandbox) {\n        // TODO: can it becomes non-extensible?\n        return true;\n    },\n    getPrototypeOf(sandbox) {\n        return null;\n    },\n    setPrototypeOf(sandbox, prototype) {\n        return prototype === null ? true : false;\n    },\n};","import {\n    setInternalEvaluation,\n    resetInternalEvaluation,\n} from \"./proxy.js\";\n\nconst HookFnName = '$RealmEvaluatorIIFE$';\n\n// Wrapping the source with `with` statement creates a new lexical scope,\n// that can prevent access to the globals in the sandbox by shadowing them\n// via globalProxy.\nfunction addLexicalScopesToSource(sourceText) {\n    /**\n     * We use a `with` statement who uses `argments[1]`, which is the\n     * `sandbox.globalProxy` that implements the shadowing mechanism.\n     * Aside from that, the `this` value in sourceText will correspond to `sandbox.globalObject`.\n     */\n    // escaping backsticks to prevent leaking the original eval as well as syntax errors\n    sourceText = sourceText.replace(/\\`/g, '\\\\`');\n    return `\n        function ${HookFnName}() {\n            with(arguments[0]) {\n                return (function(){\n                    \"use strict\";\n                    return eval(\\`${sourceText}\\`);\n                }).call(this);\n            }\n        }\n    `;\n}\n\nfunction evalAndReturn(sourceText, sandbox) {\n    const { iframeDocument, confinedWindow } = sandbox;\n    const { body: iframeBody } = iframeDocument;\n    const script = iframeDocument.createElement('script');\n    script.type = 'text/javascript';\n    confinedWindow[HookFnName] = undefined;\n    script.appendChild(iframeDocument.createTextNode(sourceText));\n    iframeBody.appendChild(script);\n    iframeBody.removeChild(script);\n    const result = confinedWindow[HookFnName];\n    confinedWindow[HookFnName] = undefined;\n    return result;\n}\n\nexport function evaluate(sourceText, sandbox) {\n    if (!sourceText) {\n        return undefined;\n    }\n    sourceText = addLexicalScopesToSource(sourceText);\n    setInternalEvaluation();\n    const fn = evalAndReturn(sourceText, sandbox);\n    const result = fn.apply(sandbox.globalObject, [sandbox.globalProxy]);\n    resetInternalEvaluation();\n    return result;\n}","import { evaluate } from \"./evaluate.js\";\n\nfunction getEvalEvaluator(sandbox) {\n    const o = {\n        // trick to set the name of the function to \"eval\"\n        eval: function(sourceText) {\n            console.log(`Shim-Evaluation: \"${sourceText}\"`);\n            return evaluate(sourceText, sandbox);\n        }\n    };\n    Object.setPrototypeOf(o.eval, sandbox.Function);\n    o.eval.toString = () => 'function eval() { [shim code] }';\n    return o.eval;\n}\n\nfunction getFunctionEvaluator(sandbox) {\n    const { confinedWindow } = sandbox;\n    const f = function Function(...args) {\n        console.log(`Shim-Evaluation: Function(\"${args.join('\", \"')}\")`);\n        const sourceText = args.pop();\n        const fnArgs = args.join(', ');\n        return evaluate(`(function anonymous(${fnArgs}){\\n${sourceText}\\n}).bind(this)`, sandbox);\n    }\n    Object.setPrototypeOf(f, confinedWindow.Function);\n    f.constructor = f;\n    f.toString = () => 'function Function() { [shim code] }';\n    confinedWindow.Function.constructor = f;\n    // Object.setPrototypeOf(confinedWindow.Function, f);\n    return f;\n}\n\nexport function getEvaluators(sandbox) {\n    sandbox.Function = getFunctionEvaluator(sandbox);\n    sandbox.eval = getEvalEvaluator(sandbox);\n}","import Realm from \"./realm.js\";\n\nconst getProto = Object.getPrototypeOf;\nconst iteratorSymbol = (typeof Symbol && Symbol.iterator) || \"@@iterator\";\n\nexport function getIntrinsics(sandbox) {\n    const { confinedWindow: _, globalObject } = sandbox;\n    const anonymousArrayIteratorPrototype = getProto(_.Array(0)[iteratorSymbol]());\n    const anonymousStringIteratorPrototype = getProto(_.String()[iteratorSymbol]());\n    const anonymousIteratorPrototype = getProto(anonymousArrayIteratorPrototype);\n\n    const strictArgumentsGenerator = _.eval('(function*(){\"use strict\";yield arguments;})');\n    const anonymousGenerator = getProto(strictArgumentsGenerator);\n    const anonymousGeneratorPrototype = getProto(anonymousGenerator);\n    const anonymousGeneratorFunction = anonymousGeneratorPrototype.constructor;\n\n    return {\n        // %Array%\n        \"Array\": _.Array,\n        // %ArrayBuffer%\n        \"ArrayBuffer\": _.ArrayBuffer,\n        // %ArrayBufferPrototype%\n        \"ArrayBufferPrototype\": _.ArrayBuffer.prototype,\n        // %ArrayIteratorPrototype%\n        \"ArrayIteratorPrototype\": anonymousArrayIteratorPrototype,\n        // %ArrayPrototype%\n        \"ArrayPrototype\": _.Array.prototype,\n        // %ArrayProto_values%\n        \"ArrayProto_values\": _.Array.prototype.values,\n        // %Boolean%\n        \"Boolean\": _.Boolean,\n        // %BooleanPrototype%\n        \"BooleanPrototype\": _.Boolean.prototype,\n        // %DataView%\n        \"DataView\": _.DataView,\n        // %DataViewPrototype%\n        \"DataViewPrototype\": _.DataView.prototype,\n        // %Date%\n        \"Date\": _.Date,\n        // %DatePrototype%\n        \"DatePrototype\": _.Date.prototype,\n        // %decodeURI%\n        \"decodeURI\": _.decodeURI,\n        // %decodeURIComponent%\n        \"decodeURIComponent\": _.decodeURIComponent,\n        // %encodeURI%\n        \"encodeURI\": _.encodeURI,\n        // %encodeURIComponent%\n        \"encodeURIComponent\": _.encodeURIComponent,\n        // %Error%\n        \"Error\": _.Error,\n        // %ErrorPrototype%\n        \"ErrorPrototype\": _.Error.prototype,\n        // %eval%\n        \"eval\": sandbox.eval,\n        // %EvalError%\n        \"EvalError\": _.EvalError,\n        // %EvalErrorPrototype% \n        \"EvalErrorPrototype\": _.EvalError.prototype,\n        // %Float32Array%\n        \"Float32Array\": _.Float32Array,\n        // %Float32ArrayPrototype%\n        \"Float32ArrayPrototype\": _.Float32Array.prototype,\n        // %Float64Array%\n        \"Float64Array\": _.Float64Array,\n        // %Float64ArrayPrototype%\n        \"Float64ArrayPrototype\": _.Float64Array.prototype,\n        // %Function%\n        \"Function\": sandbox.Function,\n        // %FunctionPrototype%\n        \"FunctionPrototype\": _.Function.prototype,\n        // %Generator%\n        \"Generator\": anonymousGenerator,\n        // %GeneratorFunction%\n        \"GeneratorFunction\": anonymousGeneratorFunction,\n        // %GeneratorPrototype%\n        \"GeneratorPrototype\": anonymousGeneratorPrototype,\n        // %Int8Array%\n        \"Int8Array\": _.Int8Array,\n        // %Int8ArrayPrototype%\n        \"Int8ArrayPrototype\": _.Int8Array.prototype,\n        // %Int16Array%\n        \"Int16Array\": _.Int16Array,\n        // %Int16ArrayPrototype%,\n        \"Int16ArrayPrototype\": _.Int16Array.prototype,\n        // %Int32Array%\n        \"Int32Array\": _.Int32Array,\n        // %Int32ArrayPrototype%\n        \"Int32ArrayPrototype\": _.Int32Array.prototype,\n        // %isFinite%\n        \"isFinite\": _.isFinite,\n        // %isNaN%\n        \"isNaN\": _.isNaN,\n        // %IteratorPrototype%\n        \"IteratorPrototype\": anonymousIteratorPrototype,\n        // %JSON%\n        \"JSON\": _.JSON,\n        // %Map%\n        \"Map\": _.Map,\n        // %MapIteratorPrototype%\n        \"MapIteratorPrototype\": undefined,\n        // %MapPrototype%\n        \"MapPrototype\": _.Map.prototype,\n        // %Math%\n        \"Math\": _.Math,\n        // %Number%\n        \"Number\": _.Number,\n        // %NumberPrototype%\n        \"NumberPrototype\": _.Number.prototype,\n        // %Object%\n        \"Object\": _.Object,\n        // %ObjectPrototype%\n        \"ObjectPrototype\": _.Object.prototype,\n        // %ObjProto_toString%\n        \"ObjProto_toString\": _.Object.prototype.toString,\n        // %ObjProto_valueOf%\n        \"ObjProto_valueOf\": _.Object.prototype.valueOf,\n        // %parseFloat%\n        \"parseFloat\": _.parseFloat,\n        // %parseInt%\n        \"parseInt\": _.parseInt,\n        // %Promise%\n        \"Promise\": _.Promise,\n        // %PromisePrototype%\n        \"PromisePrototype\": _.Promise.prototype,\n        // %Proxy%\n        \"Proxy\": _.Proxy,\n        // %RangeError%\n        \"RangeError\": _.RangeError,\n        // %RangeErrorPrototype%\n        \"RangeErrorPrototype\": _.RangeError.prototype,\n        // %ReferenceError%\n        \"ReferenceError\": _.ReferenceError,\n        // %ReferenceErrorPrototype%\n        \"ReferenceErrorPrototype\": _.ReferenceError.prototype,\n        // %Reflect%\n        \"Reflect\": _.Reflect,\n        // %RegExp%\n        \"RegExp\": _.RegExp,\n        // %RegExpPrototype%\n        \"RegExpPrototype\": _.RegExp.prototype,\n        // %Set%\n        \"Set\": _.Set,\n        // %SetIteratorPrototype%\n        \"SetIteratorPrototype\": undefined,\n        // %SetPrototype%\n        \"SetPrototype\": _.Set.prototype,\n        // %String%\n        \"String\": _.String,\n        // %StringIteratorPrototype%\n        \"StringIteratorPrototype\": anonymousStringIteratorPrototype,\n        // %StringPrototype%\n        \"StringPrototype\": _.String.prototype,\n        // %Symbol%\n        \"Symbol\": _.Symbol,\n        // %SymbolPrototype%\n        \"SymbolPrototype\": _.Symbol.prototype,\n        // %SyntaxError%\n        \"SyntaxError\": _.SyntaxError,\n        // %SyntaxErrorPrototype%\n        \"SyntaxErrorPrototype\": _.SyntaxError.prototype,\n        // %ThrowTypeError%\n        \"ThrowTypeError\": undefined,\n        // %TypedArray%\n        \"TypedArray\": undefined,\n        // %TypedArrayPrototype%\n        \"TypedArrayPrototype\": undefined,\n        // %TypeError%\n        \"TypeError\": _.TypeError,\n        // %TypeErrorPrototype%\n        \"TypeErrorPrototype\": _.TypeError.prototype,\n        // %Uint8Array%\n        \"Uint8Array\": _.Uint8Array,\n        // %Uint8ArrayPrototype%\n        \"Uint8ArrayPrototype\": _.Uint8Array.prototype,\n        // %Uint8ClampedArray%\n        \"Uint8ClampedArray\": _.Uint8ClampedArray,\n        // %Uint8ClampedArrayPrototype%\n        \"Uint8ClampedArrayPrototype\": _.Uint8ClampedArray.prototype,\n        // %Uint16Array%\n        \"Uint16Array\": _.Uint16Array,\n        // %Uint16ArrayPrototype%\n        \"Uint16ArrayPrototype\": Uint16Array.prototype,\n        // %Uint32Array%\n        \"Uint32Array\": _.Uint32Array,\n        // %Uint32ArrayPrototype%\n        \"Uint32ArrayPrototype\": _.Uint32Array.prototype,\n        // %URIError%\n        \"URIError\": _.URIError,\n        // %URIErrorPrototype%\n        \"URIErrorPrototype\": _.URIError.prototype,\n        // %WeakMap%\n        \"WeakMap\": _.WeakMap,\n        // %WeakMapPrototype%\n        \"WeakMapPrototype\": _.WeakMap.prototype,\n        // %WeakSet%\n        \"WeakSet\": _.WeakSet,\n        // %WeakSetPrototype%\n        \"WeakSetPrototype\": _.WeakSet.prototype,\n        \n        // TODO: Annex B\n        // TODO: other special cases\n\n        // ESNext\n        global: globalObject,\n        Realm,\n    };\n}","import { getIntrinsics } from \"./intrinsics.js\";\n\nexport function getStdLib(sandbox) {\n    const intrinsics = getIntrinsics(sandbox);\n    return {\n        Array: { value: intrinsics.Array },\n        ArrayBuffer: { value: intrinsics.ArrayBuffer },\n        Boolean: { value: intrinsics.Boolean },\n        DataView: { value: intrinsics.DataView },\n        Date: { value: intrinsics.Date },\n        decodeURI: { value: intrinsics.decodeURI },\n        decodeURIComponent: { value: intrinsics.decodeURIComponent },\n        encodeURI: { value: intrinsics.encodeURI },\n        encodeURIComponent: { value: intrinsics.encodeURIComponent },\n        Error: { value: intrinsics.Error },\n        eval: { value: intrinsics.eval },\n        EvalError: { value: intrinsics.EvalError },\n        Float32Array: { value: intrinsics.Float32Array },\n        Float64Array: { value: intrinsics.Float64Array },\n        Function: { value: intrinsics.Function },\n        Int8Array: { value: intrinsics.Int8Array },\n        Int16Array: { value: intrinsics.Int16Array },\n        Int32Array: { value: intrinsics.Int32Array },\n        isFinite: { value: intrinsics.isFinite },\n        isNaN: { value: intrinsics.isNaN },\n        JSON: { value: intrinsics.JSON },\n        Map: { value: intrinsics.Map },\n        Math: { value: intrinsics.Math },\n        Number: { value: intrinsics.Number },\n        Object: { value: intrinsics.Object },\n        parseFloat: { value: intrinsics.parseFloat },\n        parseInt: { value: intrinsics.parseInt },\n        Promise: { value: intrinsics.Promise },\n        Proxy: { value: intrinsics.Proxy },\n        RangeError: { value: intrinsics.RangeError },\n        ReferenceError: { value: intrinsics.ReferenceError },\n        Reflect: { value: intrinsics.Reflect },\n        RegExp: { value: intrinsics.RegExp },\n        Set: { value: intrinsics.Set },\n        String: { value: intrinsics.String },\n        Symbol: { value: intrinsics.Symbol },\n        SyntaxError: { value: intrinsics.SyntaxError },\n        TypeError: { value: intrinsics.TypeError },\n        Uint8Array: { value: intrinsics.Uint8Array },\n        Uint8ClampedArray: { value: intrinsics.Uint8ClampedArray },\n        Uint16Array: { value: intrinsics.Uint16Array },\n        Uint32Array: { value: intrinsics.Uint32Array },\n        URIError: { value: intrinsics.URIError },\n        WeakMap: { value: intrinsics.WeakMap },\n        WeakSet: { value: intrinsics.WeakSet },\n        \n        // TODO: Annex B\n        // TODO: other special cases\n\n        // ESNext\n        global: { value: intrinsics.global },\n        Realm: { value: intrinsics.Realm },\n    };\n}","import { createSandbox } from \"./sandbox.js\";\nimport { sanitize } from \"./sanitize.js\";\nimport { evaluate } from \"./evaluate.js\";\nimport { getEvaluators } from \"./evaluators.js\";\nimport { getStdLib } from \"./stdlib.js\";\nimport { getIntrinsics } from \"./intrinsics.js\";\nimport { proxyHandler } from \"./proxy.js\";\n\nconst RealmToSandbox = new WeakMap();\n\nfunction getSandbox(realm) {\n    const sandbox = RealmToSandbox.get(realm);\n    if (!sandbox) {\n        throw new Error(`Invalid realm object.`);\n    }\n    return sandbox;\n}\n\nexport default class Realm {\n\n    constructor() {\n        const sandbox = createSandbox();\n        sanitize(sandbox);\n        Object.assign(sandbox, getEvaluators(sandbox));\n        // TODO: assert that RealmToSandbox does not have `this` entry\n        RealmToSandbox.set(this, sandbox);\n        sandbox.globalProxy = new Proxy(sandbox, proxyHandler);\n        this.global = sandbox.globalObject;\n        this.init();\n    }\n\n    init() {\n        Object.defineProperties(this.global, this.stdlib);\n    }\n\n    eval(sourceText) {\n        const sandbox = getSandbox(this);\n        return evaluate(sourceText, sandbox);\n    }\n\n    get stdlib() {\n        const sandbox = getSandbox(this);\n        return getStdLib(sandbox);\n    }\n\n    get intrinsics() {\n        const sandbox = getSandbox(this);\n        return getIntrinsics(sandbox);\n    }\n\n}\n\nRealm.toString = () => 'function Realm() { [shim code] }';"],"names":["createIframe","el","document","createElement","style","display","title","setAttribute","body","appendChild","createSandbox","iframe","iframeDocument","contentDocument","confinedWindow","contentWindow","globalObject","Object","create","undefined","sanitize","sandbox","o","defineProperty","prototype","key","fn","d","p","getOwnPropertyDescriptor","getPrototypeOf","get","set","seal","ignore","isInternalEvaluation","setInternalEvaluation","resetInternalEvaluation","proxyHandler","propName","eval","newValue","descriptor","Reflect","deleteProperty","ReferenceError","getOwnPropertyNames","HookFnName","addLexicalScopesToSource","sourceText","replace","evalAndReturn","iframeBody","script","type","createTextNode","removeChild","result","evaluate","apply","globalProxy","getEvalEvaluator","log","setPrototypeOf","Function","toString","getFunctionEvaluator","f","args","join","pop","fnArgs","constructor","getEvaluators","getProto","iteratorSymbol","Symbol","iterator","getIntrinsics","_","anonymousArrayIteratorPrototype","Array","anonymousStringIteratorPrototype","String","anonymousIteratorPrototype","strictArgumentsGenerator","anonymousGenerator","anonymousGeneratorPrototype","anonymousGeneratorFunction","ArrayBuffer","values","Boolean","DataView","Date","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","Error","EvalError","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","isFinite","isNaN","JSON","Map","Math","Number","valueOf","parseFloat","parseInt","Promise","Proxy","RangeError","RegExp","Set","SyntaxError","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","URIError","WeakMap","WeakSet","getStdLib","intrinsics","value","global","Realm","RealmToSandbox","getSandbox","realm","assign","init","defineProperties","stdlib"],"mappings":"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"}